<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>libmodbus ä½¿ç”¨æŒ‡å—</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #e0e0ff;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(30, 30, 60, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }
        h1 { font-size: 2.5em; color: #6ab7ff; margin-bottom: 10px; }
        .subtitle { font-size: 1.2em; color: #a0a0ff; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px solid rgba(100, 150, 255, 0.3); }
        h2 { font-size: 1.8em; color: #4cd1a8; margin-top: 40px; margin-bottom: 20px; }
        h3 { font-size: 1.4em; color: #ff9f7f; margin-top: 30px; margin-bottom: 15px; }
        pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin-bottom: 25px;
            border: 1px solid rgba(100, 150, 255, 0.2);
        }
        pre code { color: #e0e0ff; font-size: 0.9em; line-height: 1.6; }
        .info-box {
            background: rgba(106, 183, 255, 0.15);
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid rgba(106, 183, 255, 0.3);
        }
        .back-link {
            position: fixed;
            right: 30px;
            top: 30px;
            z-index: 1000;
            padding: 12px 24px;
            background: rgba(76, 209, 168, 0.15);
            border: 2px solid rgba(76, 209, 168, 0.3);
            border-radius: 25px;
            color: #4cd1a8;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        .back-link:hover {
            background: rgba(76, 209, 168, 0.25);
            border-color: rgba(76, 209, 168, 0.5);
            box-shadow: 0 6px 20px rgba(76, 209, 168, 0.4);
            transform: translateY(-2px);
        }
        a { color: #4cd1a8; text-decoration: none; }
        a:hover { color: #6ab7ff; }

        footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(76, 209, 168, 0.3);
            text-align: center;
        }

        .footer-text {
            color: #a0a0ff;
            font-size: 0.9em;
            margin: 5px 0;
        }

        .contact-link {
            color: #4cd1a8;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .contact-link:hover {
            color: #ff9f7f;
            text-shadow: 0 0 5px rgba(255, 159, 127, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›åº“åˆ—è¡¨</a>

        <h1>ğŸ“¡ libmodbus ä½¿ç”¨æŒ‡å—</h1>
        <p class="subtitle">Modbus åè®®é€šä¿¡åº“</p>

        <div class="info-box">
            <p><strong>é¡¹ç›®åœ°å€ï¼š</strong><a href="https://github.com/stephane/libmodbus" target="_blank">https://github.com/stephane/libmodbus</a></p>
            <p><strong>å®˜æ–¹æ–‡æ¡£ï¼š</strong><a href="https://libmodbus.org/documentation/" target="_blank">https://libmodbus.org/documentation/</a></p>
        </div>

        <h2>ğŸ“– ä»€ä¹ˆæ˜¯ libmodbusï¼Ÿ</h2>
        <p>libmodbus æ˜¯ä¸€ä¸ªå…è´¹çš„å¼€æºè½¯ä»¶åº“ï¼Œç”¨äºä¸éµå®ˆ Modbus åè®®çš„è®¾å¤‡å‘é€/æ¥æ”¶æ•°æ®ã€‚è¯¥åº“å¯ä»¥ä½¿ç”¨ä¸²å£æˆ–ä»¥å¤ªç½‘è¿æ¥ã€‚åº“ä¸­çš„å‡½æ•°æºè‡ª Modicon Modbus åè®®å‚è€ƒæŒ‡å—ã€‚</p>

        <h2>ğŸš€ å®‰è£…æ–¹å¼</h2>

        <h3>Linux (Ubuntu/Debian)</h3>
        <pre><code>sudo apt-get update
sudo apt-get install libmodbus-dev</code></pre>

        <h3>macOS (Homebrew)</h3>
        <pre><code>brew install libmodbus</code></pre>

        <h3>ä»æºç ç¼–è¯‘</h3>
        <pre><code># å®‰è£…ä¾èµ–
sudo apt-get install autoconf automake libtool

# å…‹éš†ä»“åº“
git clone https://github.com/stephane/libmodbus.git
cd libmodbus

# ç”Ÿæˆé…ç½®è„šæœ¬
./autogen.sh

# é…ç½®ã€ç¼–è¯‘å’Œå®‰è£…
./configure --prefix=/usr/local
make
sudo make install

# æ›´æ–°åº“ç¼“å­˜
sudo ldconfig</code></pre>

        <h2>ğŸ’¡ åŸºç¡€ä½¿ç”¨</h2>

        <h3>Modbus TCP å®¢æˆ·ç«¯ - è¯»å–å¯„å­˜å™¨</h3>
        <pre><code>#include &lt;iostream&gt;
#include &lt;modbus/modbus.h&gt;

int main() {
    modbus_t *ctx = NULL;
    uint16_t tab_reg[32];
    int rc;
    int i;

    // åˆ›å»º Modbus TCP ä¸Šä¸‹æ–‡
    ctx = modbus_new_tcp("127.0.0.1", 502);
    if (ctx == NULL) {
        std::cerr &lt;&lt; "æ— æ³•åˆ›å»º Modbus ä¸Šä¸‹æ–‡" &lt;&lt; std::endl;
        return -1;
    }

    // è¿æ¥åˆ°è®¾å¤‡
    if (modbus_connect(ctx) == -1) {
        std::cerr &lt;&lt; "è¿æ¥å¤±è´¥: " &lt;&lt; modbus_strerror(errno) &lt;&lt; std::endl;
        modbus_free(ctx);
        return -1;
    }

    std::cout &lt;&lt; "å·²è¿æ¥åˆ° Modbus è®¾å¤‡" &lt;&lt; std::endl;

    // è¯»å–ä¿æŒå¯„å­˜å™¨
    rc = modbus_read_registers(ctx, 0, 0, 10, tab_reg);
    if (rc == -1) {
        std::cerr &lt;&lt; "è¯»å–å¯„å­˜å™¨å¤±è´¥" &lt;&lt; std::endl;
    } else {
        std::cout &lt;&lt; "è¯»å–åˆ° " &lt;&lt; rc &lt;&lt; " ä¸ªå¯„å­˜å™¨:" &lt;&lt; std::endl;
        for (i = 0; i &lt; rc; i++) {
            std::cout &lt;&lt; "[" &lt;&lt; i &lt;&lt; "]: " &lt;&lt; tab_reg[i] &lt;&lt; std::endl;
        }
    }

    // å…³é—­è¿æ¥å’Œé‡Šæ”¾èµ„æº
    modbus_close(ctx);
    modbus_free(ctx);

    return 0;
}</code></pre>

        <h3>Modbus RTU å®¢æˆ·ç«¯ - ä¸²å£é€šä¿¡</h3>
        <pre><code>#include &lt;iostream&gt;
#include &lt;modbus/modbus.h&gt;

int main() {
    modbus_t *ctx = NULL;
    uint16_t tab_reg[32];
    int rc;

    // åˆ›å»º Modbus RTU ä¸Šä¸‹æ–‡ï¼ˆä¸²å£ï¼‰
    ctx = modbus_new_rtu("/dev/ttyUSB0", 19200, 'N', 8, 1);
    if (ctx == NULL) {
        std::cerr &lt;&lt; "æ— æ³•åˆ›å»º RTU ä¸Šä¸‹æ–‡" &lt;&lt; std::endl;
        return -1;
    }

    // è®¾ç½® RTU æ¨¡å¼
    modbus_set_slave(ctx, 1);  // ä»ç«™åœ°å€
    modbus_rtu_set_serial_mode(ctx, MODBUS_RTU_RS232);
    modbus_rtu_set_rts(ctx, MODBUS_RTU_RTS_UP);

    // è¿æ¥åˆ°è®¾å¤‡
    if (modbus_connect(ctx) == -1) {
        std::cerr &lt;&lt; "è¿æ¥å¤±è´¥" &lt;&lt; std::endl;
        modbus_free(ctx);
        return -1;
    }

    std::cout &lt;&lt; "å·²è¿æ¥åˆ° RTU è®¾å¤‡" &lt;&lt; std::endl;

    // è¯»å–è¾“å…¥å¯„å­˜å™¨
    rc = modbus_read_input_registers(ctx, 0, 0, 10, tab_reg);
    if (rc == -1) {
        std::cerr &lt;&lt; "è¯»å–å¤±è´¥" &lt;&lt; std::endl;
    } else {
        for (int i = 0; i &lt; rc; i++) {
            std::cout &lt;&lt; "è¾“å…¥å¯„å­˜å™¨ " &lt;&lt; i &lt;&lt; ": " &lt;&lt; tab_reg[i] &lt;&lt; std::endl;
        }
    }

    modbus_close(ctx);
    modbus_free(ctx);

    return 0;
}</code></pre>

        <h3>å†™å…¥å•ä¸ªå¯„å­˜å™¨</h3>
        <pre><code>modbus_t *ctx = modbus_new_tcp("192.168.1.100", 502);

if (modbus_connect(ctx) == -1) {
    std::cerr &lt;&lt; "è¿æ¥å¤±è´¥" &lt;&lt; std::endl;
    modbus_free(ctx);
    return -1;
}

// è®¾ç½®ä»ç«™åœ°å€
modbus_set_slave(ctx, 1);

// å†™å…¥å•ä¸ªä¿æŒå¯„å­˜å™¨
uint16_t value = 1234;
int rc = modbus_write_register(ctx, 0, value);

if (rc == -1) {
    std::cerr &lt;&lt; "å†™å…¥å¤±è´¥: " &lt;&lt; modbus_strerror(errno) &lt;&lt; std::endl;
} else {
    std::cout &lt;&lt; "å†™å…¥æˆåŠŸï¼Œå€¼: " &lt;&lt; value &lt;&lt; std::endl;
}

modbus_close(ctx);
modbus_free(ctx);</code></pre>

        <h3>å†™å…¥å¤šä¸ªå¯„å­˜å™¨</h3>
        <pre><code>modbus_t *ctx = modbus_new_tcp("192.168.1.100", 502);

modbus_connect(ctx);
modbus_set_slave(ctx, 1);

// å‡†å¤‡æ•°æ®
uint16_t tab_reg[10];
for (int i = 0; i &lt; 10; i++) {
    tab_reg[i] = i * 100;
}

// å†™å…¥å¤šä¸ªä¿æŒå¯„å­˜å™¨
int rc = modbus_write_registers(ctx, 0, 10, tab_reg);

if (rc == -1) {
    std::cerr &lt;&lt; "æ‰¹é‡å†™å…¥å¤±è´¥" &lt;&lt; std::endl;
} else {
    std::cout &lt;&lt; "æˆåŠŸå†™å…¥ " &lt;&lt; rc &lt;&lt; " ä¸ªå¯„å­˜å™¨" &lt;&lt; std::endl;
}

modbus_close(ctx);
modbus_free(ctx);</code></pre>

        <h3>è¯»å–çº¿åœˆ</h3>
        <pre><code>modbus_t *ctx = modbus_new_tcp("192.168.1.100", 502);

modbus_connect(ctx);
modbus_set_slave(ctx, 1);

// è¯»å–çº¿åœˆ
uint8_t tab_bits[32];
int rc = modbus_read_bits(ctx, 0, 10, tab_bits);

if (rc == -1) {
    std::cerr &lt;&lt; "è¯»å–çº¿åœˆå¤±è´¥" &lt;&lt; std::endl;
} else {
    std::cout &lt;&lt; "è¯»å–åˆ° " &lt;&lt; rc &lt;&lt; " ä¸ªçº¿åœˆ:" &lt;&lt; std::endl;
    for (int i = 0; i &lt; rc; i++) {
        std::cout &lt;&lt; "çº¿åœˆ " &lt;&lt; i &lt;&lt; ": " &lt;&lt; (tab_bits[i] ? "ON" : "OFF") &lt;&lt; std::endl;
    }
}

modbus_close(ctx);
modbus_free(ctx);</code></pre>

        <h3>å†™å…¥çº¿åœˆ</h3>
        <pre><code>modbus_t *ctx = modbus_new_tcp("192.168.1.100", 502);

modbus_connect(ctx);
modbus_set_slave(ctx, 1);

// å†™å…¥å•ä¸ªçº¿åœˆ
int rc = modbus_write_bit(ctx, 0, 1);  // åœ°å€ 0ï¼Œå€¼ 1 (ONï¼‰

if (rc == -1) {
    std::cerr &lt;&lt; "å†™å…¥çº¿åœˆå¤±è´¥" &lt;&lt; std::endl;
} else {
    std::cout &lt;&lt; "çº¿åœˆè®¾ç½®æˆåŠŸ" &lt;&lt; std::endl;
}

// å†™å…¥å¤šä¸ªçº¿åœˆ
uint8_t tab_bits[2] = {1, 0};
rc = modbus_write_bits(ctx, 0, 2, tab_bits);

modbus_close(ctx);
modbus_free(ctx);</code></pre>

        <h3>Modbus TCP æœåŠ¡å™¨</h3>
        <pre><code>#include &lt;iostream&gt;
#include &lt;modbus/modbus.h&gt;
#include &lt;modbus/modbus-tcp.h&gt;
#include &lt;unistd.h&gt;

#define MODBUS_TCP_PORT 502
#define SERVER_ADDRESS "0.0.0.0"

int main() {
    int socket;
    modbus_t *ctx;
    modbus_mapping_t *mb_mapping;
    uint8_t query[MODBUS_TCP_MAX_ADU_LENGTH];
    int rc;

    // åˆ›å»º Modbus TCP ä¸Šä¸‹æ–‡
    ctx = modbus_new_tcp(NULL, MODBUS_TCP_PORT);
    if (ctx == NULL) {
        std::cerr &lt;&lt; "æ— æ³•åˆ›å»ºä¸Šä¸‹æ–‡" &lt;&lt; std::endl;
        return -1;
    }

    // åˆ›å»ºæ˜ å°„è¡¨
    mb_mapping = modbus_mapping_new(500, 500, 500, 500);
    if (mb_mapping == NULL) {
        std::cerr &lt;&lt; "æ— æ³•åˆ›å»ºæ˜ å°„" &lt;&lt; std::endl;
        modbus_free(ctx);
        return -1;
    }

    // è®¾ç½®åˆå§‹æ•°æ®
    for (int i = 0; i &lt; 500; i++) {
        mb_mapping->tab_registers[i] = i;
    }

    // å¯åŠ¨æœåŠ¡å™¨
    socket = modbus_tcp_listen(ctx, 1);
    if (socket == -1) {
        std::cerr &lt;&lt; "æ— æ³•å¯åŠ¨æœåŠ¡å™¨" &lt;&lt; std::endl;
        modbus_mapping_free(mb_mapping);
        modbus_free(ctx);
        return -1;
    }

    std::cout &lt;&lt; "Modbus TCP æœåŠ¡å™¨è¿è¡Œä¸­..." &lt;&lt; std::endl;

    // æ¥å—è¿æ¥
    while (1) {
        int client_socket = modbus_tcp_accept(ctx, &socket);
        if (client_socket == -1) {
            continue;
        }

        std::cout &lt;&lt; "å®¢æˆ·ç«¯å·²è¿æ¥" &lt;&lt; std::endl;

        // å¤„ç†è¯·æ±‚
        while (1) {
            rc = modbus_receive(ctx, query);
            if (rc > 0) {
                // å¤„ç†æŸ¥è¯¢
                rc = modbus_reply(ctx, query, rc, mb_mapping);
            } else if (rc == -1) {
                break;
            }
        }

        close(client_socket);
    }

    modbus_mapping_free(mb_mapping);
    modbus_free(ctx);

    return 0;
}</code></pre>

        <h3>è®¾ç½®è¶…æ—¶å’Œé‡è¯•</h3>
        <pre><code>modbus_t *ctx = modbus_new_tcp("192.168.1.100", 502);

// è®¾ç½®å“åº”è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
struct timeval response_timeout;
response_timeout.tv_sec = 1;  // 1ç§’
response_timeout.tv_usec = 0;
modbus_set_response_timeout(ctx, &response_timeout);

// è®¾ç½®å­—èŠ‚é—´è¶…æ—¶
struct timeval byte_timeout;
byte_timeout.tv_sec = 0;
byte_timeout.tv_usec = 500000;  // 500æ¯«ç§’
modbus_set_byte_timeout(ctx, &byte_timeout);

// è°ƒè¯•æ¨¡å¼ï¼ˆæ‰“å° Modbus å¸§ï¼‰
modbus_set_debug(ctx, TRUE);

// è®¾ç½®é‡è¯•æ¬¡æ•°
int retries = 3;
while (retries-- > 0) {
    int rc = modbus_read_registers(ctx, 0, 0, 10, tab_reg);
    if (rc != -1) break;
    
    std::cout &lt;&lt; "é‡è¯•... å‰©ä½™: " &lt;&lt; retries &lt;&lt; std::endl;
    usleep(100000);  // ç­‰å¾… 100ms
}</code></pre>

        <h2>ğŸ¯ Modbus åŠŸèƒ½ç é€ŸæŸ¥</h2>
        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
            <tr style="background: rgba(106, 183, 255, 0.2);">
                <th style="padding: 12px; text-align: left; color: #6ab7ff;">åŠŸèƒ½</th>
                <th style="padding: 12px; text-align: left; color: #6ab7ff;">åŠŸèƒ½ç </th>
                <th style="padding: 12px; text-align: left; color: #6ab7ff;">libmodbus å‡½æ•°</th>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);">è¯»å–çº¿åœˆ</td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);">0x01</td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);"><code>modbus_read_bits()</code></td>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);">è¯»å–ç¦»æ•£è¾“å…¥</td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);">0x02</td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);"><code>modbus_read_input_bits()</code></td>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);">è¯»å–ä¿æŒå¯„å­˜å™¨</td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);">0x03</td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);"><code>modbus_read_registers()</code></td>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);">è¯»å–è¾“å…¥å¯„å­˜å™¨</td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);">0x04</td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);"><code>modbus_read_input_registers()</code></td>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);">å†™å…¥å•ä¸ªçº¿åœˆ</td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);">0x05</td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);"><code>modbus_write_bit()</code></td>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);">å†™å…¥å•ä¸ªå¯„å­˜å™¨</td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);">0x06</td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(100, 150, 255, 0.1);"><code>modbus_write_register()</code></td>
            </tr>
            <tr>
                <td style="padding: 10px;">å†™å…¥å¤šä¸ªå¯„å­˜å™¨</td>
                <td style="padding: 10px;">0x10</td>
                <td style="padding: 10px;"><code>modbus_write_registers()</code></td>
            </tr>
        </table>

        <h2>ğŸ“š æ›´å¤šèµ„æº</h2>
        <ul>
            <li><a href="https://libmodbus.org/documentation/" target="_blank">libmodbus å®˜æ–¹æ–‡æ¡£</a></li>
            <li><a href="https://github.com/stephane/libmodbus" target="_blank">GitHub ä»“åº“</a></li>
            <li><a href="https://libmodbus.org/documentation/v3.1.6/" target="_blank">API æ–‡æ¡£</a></li>
        </ul>

        <!-- é¡µè„š -->
        <footer>
            <p class="footer-text">&copy; 2026 C++ å¼€æºåº“ç²¾é€‰åŸºåœ°. ç‰ˆæƒæ‰€æœ‰Â·LEVI</p>
            <p class="footer-text">å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»: <a href="mailto:373102227@qq.com" class="contact-link">373102227@qq.com</a></p>
        </footer>
    </div>
</body>
</html>
